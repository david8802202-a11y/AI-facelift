import streamlit as st
import google.generativeai as genai
import random
import re

# --- 1. é é¢è¨­å®š ---
st.set_page_config(page_title="PTT æ–‡æ¡ˆç”¢ç”Ÿå™¨ V54", page_icon="âš–ï¸")
api_key = st.secrets.get("GOOGLE_API_KEY")

if not api_key:
    st.error("âŒ æ‰¾ä¸åˆ° API Key")
    st.stop()

genai.configure(api_key=api_key)

# --- 2. æ·±åº¦çµæ§‹åŒ–è³‡æ–™åº« (ä¾†è‡ªæ‚¨çš„ 8 å€‹æª”æ¡ˆ) ---
DB = {
    "ğŸ’‰ é‡åŠ‘/å¾®æ•´": {
        "topics": ["ç»å°¿é…¸å¡«è£œ", "è‚‰æ¯’ç˜¦è‡‰", "é™è§£é…¶å‡¹é™·", "è€³å‚æ‹›è²¡é‡"],
        "examples": [
            {"title": "[è¨è«–] é‡åŠ‘é†«ç¾æ ¹æœ¬æ˜¯ç„¡åº•æ´...ç®—å®Œå¹´è²»åš‡æ­»äºº", "content": "ä»¥å‰è¦ºå¾—æ‰‹è¡“è²´ï¼Œçµæœé‡åŠ‘æ‰æ˜¯éŒ¢å‘ã€‚è‚‰æ¯’ç»å°¿é…¸ä¸€å¹´ç¶­è­·è²»ç«Ÿç„¶è¦10å¹¾è¬ï¼", "cmts": ["æ¨|å¾®æ•´å°±æ˜¯è¨‚é–±åˆ¶", "æ¨|é€™å°±æ˜¯æº«æ°´ç…®é’è›™", "æ¨|ç®—å®Œä¸æ•¢é¢å°è²¡å¯Œè‡ªç”±äº†"]},
            {"title": "[è¨è«–] è½èªªæ‰“é™è§£é…¶æœƒé€£è‡ªå·±çš„è‚‰ä¸€èµ·æº¶æ‰?", "content": "é™è§£é…¶æœƒé€£è‡ªé«”é€æ˜è³ªé…¸ä¸€èµ·æº¶æ‰ï¼Œå°è‡´çš®è†šè®Šä¹¾ã€çœŸçš®å±¤èç¸®å‡¹é™·è®Šæˆä¸€å€‹å‘ï¼Ÿ", "cmts": ["æ¨|æœƒå‡¹+1 é™è§£é…¶æ•µæˆ‘ä¸åˆ†", "æ¨|è½èªªçš®è†šè®Šå¾—å¾ˆè–„å¾ˆçšº", "æ¨|çœ‹éæœ‰äººæ‰“å®Œæ·šæºç›´æ¥å‡¹ä¸€å¡Š"]}
        ]
    },
    "âš¡ é›»éŸ³æ³¢/é›·å°„": {
        "topics": ["é³³å‡°é›»æ³¢", "éŸ“ç‰ˆé›»æ³¢å¹³æ›¿", "çš®ç§’é›·å°„", "æµ·èŠ™éŸ³æ³¢"],
        "examples": [
            {"title": "[è¨è«–] éŸ“ç‰ˆé›»æ³¢çœŸçš„æ˜¯å¹³æ›¿?é‚„æ˜¯çµ¦çª®äººæ‰“çš„å®‰æ…°åŠ‘", "content": "ç¾åœ‹é›»æ³¢æ¼²å¤ªå…‡ï¼Œè¨ºæ‰€æ¨éŸ“ç‰ˆåƒ¹æ ¼1/3ã€‚åˆ°åº•æ˜¯çœŸå¹³æ›¿ï¼Œé‚„æ˜¯æ‰“å¿ƒå®‰çš„å®‰æ…°åŠ‘?", "cmts": ["æ¨|æ‰“éç©ç¾ çœŸçš„å°±æ˜¯å®‰æ…°åŠ‘", "æ¨|é³³å‡°è²´åœ¨å°ˆåˆ©ï¼ŒéŸ“ç‰ˆåƒç†±çŸ³æŒ‰æ‘©", "æ¨|æƒ³é€†é½¡é‚„æ˜¯ä¹–ä¹–åˆ·å¡æ‰“é³³å‡°"]}
        ]
    },
    "ğŸ¥ é†«ç¾è¨ºæ‰€/é»‘å¹•": {
        "topics": ["è«®è©¢å¸«è©±è¡“", "å¯©ç¾è§€å–ªå¤±", "æµ·å¤–é†«ç¾å»£å‘Š", "åƒ¹æ ¼ä¸é€æ˜"],
        "examples": [
            {"title": "[è¨è«–] é†«ç¾åšä¹…çœŸçš„æœƒå–ªå¤±å°æ­£å¸¸äººé•·ç›¸çš„åˆ¤æ–·åŠ›å—?", "content": "å¯©ç¾è§€å£æ‰äº†ï¼Œçœ‹è·¯äººéƒ½æ˜¯ç‘•ç–µã€‚æ˜¯ä¸æ˜¯å¿˜è¨˜æ­£å¸¸äººé¡è©²æœ‰çš„æ¨£å­äº†?", "cmts": ["æ¨|é†«ç¾æˆç™®ç—‡æœƒç„¡é™æ”¾å¤§ç‘•ç–µ", "æ¨|çœ‹è«®è©¢å¸«æ•´å¼µè‡‰é¥…åŒ–äº†é‚„è¦ºå¾—ç¾", "æ¨|é€™å°±æ˜¯ç‚ºä»€éº¼è·¯ä¸Šè¤‡è£½äººè¶Šä¾†è¶Šå¤š"]}
        ]
    },
    "ğŸ”ª æ•´å½¢æ‰‹è¡“": {
        "topics": ["éš†ä¹³æ‰‹è¡“å¿ƒå¾—", "éš†é¼»å‰¯ä½œç”¨", "æŠ½è„‚è¡“å¾Œå‡¹å‡¸", "é›™çœ¼çš®å¤±æ•—"],
        "examples": [
            {"title": "[è¨è«–] ç”·ç”Ÿèªªå–œæ­¡è‡ªç„¶ç¾å¥³ å…¶å¯¦æ ¹æœ¬åˆ†ä¸å‡ºä¾†å§", "content": "ç›´ç”·è¨å­çš„æ˜¯å¤±æ•—çš„æ•´å½¢ï¼Œåªè¦æ²’è®Šè›‡ç²¾è‡‰ä»–å€‘éƒ½è¦ºå¾—æ˜¯å¤©ç„¶ã€‚", "cmts": ["æ¨|é€£æ·¡å¦éƒ½åˆ†ä¸å‡ºä¾†äº†", "æ¨|åªè¦æ¼‚äº®é †çœ¼å°±æ˜¯å¤©ç„¶", "æ¨|è²´çš„é†«ç¾å°±æ˜¯è®“ä½ è®Šç¾ä½†çœ‹ä¸å‡ºä¾†"]}
        ]
    }
}

# --- 3. æ¨¡å‹é€£ç·š ---
@st.cache_resource
def get_safe_model():
    try:
        return genai.GenerativeModel("gemini-1.5-flash") # ä½¿ç”¨æœ€ç©©å®šçš„æ¨¡å‹
    except:
        return genai.GenerativeModel("gemini-pro")

model = get_safe_model()

# --- 4. ä¸»ä»‹é¢ ---
if 'titles' not in st.session_state: st.session_state.titles = []

col1, col2 = st.columns(2)
with col1:
    tag = st.selectbox("æ¨™ç±¤ï¼š", ["[è¨è«–]", "[å•é¡Œ]", "[å¿ƒå¾—]", "[é–’èŠ]", "[é»‘ç‰¹]"])
    cat = st.selectbox("è­°é¡Œï¼š", list(DB.keys()))
with col2:
    tone = st.select_slider("å¼·åº¦ï¼š", ["æº«å’Œ", "ç†±çƒˆ", "ç‚ä¸Š"], value="ç†±çƒˆ")

st.markdown("---")
imported = st.text_area("åŒ¯å…¥åŸæ–‡ (è‹¥æœ‰ï¼ŒAI æœƒä»¥æ­¤ç‚ºæ ¸å¿ƒæ”¹å¯«)ï¼š", height=80)

# --- 5. ç”Ÿæˆæ¨™é¡Œ ---
if st.button("ğŸš€ ç”Ÿæˆ 5 å€‹æ¨™é¡Œ", use_container_width=True):
    # ä¸»é¡Œé–å®šé‚è¼¯
    core_topic = imported.strip() if imported.strip() else random.choice(DB[cat]["topics"])
    
    # åªæŠ½å–åŒåˆ†é¡çš„åƒè€ƒ
    ref = DB[cat]["examples"][0]["title"]
    
    prompt = f"""ä½ æ˜¯ PTT é†«ç¾ç‰ˆé„‰æ°‘ã€‚
    è«‹åƒè€ƒé€™å€‹æ¨™é¡Œçš„èªæ°£ï¼š{ref}
    
    ä»»å‹™ï¼šé‡å°ã€Œ{core_topic}ã€ç™¼æƒ³ 5 å€‹æ–°æ¨™é¡Œã€‚
    è¦å‰‡ï¼š
    1. å¿…é ˆæ˜¯ã€Œ{tag} å…§å®¹ã€ã€‚å…§å®¹é–å®šåœ¨ã€Œ{core_topic}ã€ï¼Œç¦æ­¢æåˆ°å…¶ä»–ã€‚
    2. ç¦æ­¢å†’è™Ÿã€ç¦æ­¢ç·¨è™Ÿã€ç¦æ­¢ Emojiã€‚
    ä¸€è¡Œä¸€å€‹æ¨™é¡Œã€‚"""

    try:
        res = model.generate_content(prompt).text.strip().split('\n')
        # æ¥µç°¡æ¸…æ´—
        st.session_state.titles = [f"{tag} {re.sub(r'^.*?\]', '', t).strip()}" for t in res if t.strip()][:5]
    except:
        st.error("é€£ç·šè¶…æ™‚ï¼Œè«‹å†æŒ‰ä¸€æ¬¡æŒ‰éˆ•")

# --- 6. é¸æ“‡èˆ‡æ’°å¯« ---
if st.session_state.titles:
    st.markdown("### ğŸ‘‡ é»æ“Šæ¨™é¡Œ")
    for i, t in enumerate(st.session_state.titles):
        if st.button(t, key=f"t_{i}", use_container_width=True):
            st.session_state.sel = t
            st.session_state.titles = []
            st.rerun()

if 'sel' in st.session_state:
    st.divider()
    st.subheader(f"ğŸ“ {st.session_state.sel}")
    
    if st.button("âœï¸ æ’°å¯«å…§æ–‡"):
        with st.spinner("æ’°å¯«ä¸­..."):
            # é¸å–åƒè€ƒç¯„æœ¬
            match = DB[cat]["examples"][0]
            
            prompt = f"""ä½ æ˜¯ä¸€å€‹ PTT é„‰æ°‘ã€‚
            æ¨¡ä»¿é€™ç¯‡ç¯„æ–‡çš„å£èªæ„Ÿï¼š
            æ¨™é¡Œï¼š{match['title']}
            å…§æ–‡ï¼š{match['content']}
            å›æ–‡ï¼š{match['cmts'][0]}
            
            ç¾åœ¨è«‹å¯«ï¼š
            æ¨™é¡Œï¼š{st.session_state.sel}
            èªæ°£ï¼š{tone}
            å…§å®¹ç´ æï¼š{imported if imported else cat}
            
            è¦æ±‚ï¼š
            1. å…§æ–‡ 120 å­—ï¼Œå£èªåŒ–ï¼Œç¦æ­¢å•å€™ã€‚
            2. å…§å®¹å¿…é ˆè·Ÿæ¨™é¡Œä¸€è‡´ã€‚æ¨™é¡Œæ˜¯æ‰‹è¡“å°±å¯«æ‰‹è¡“ï¼Œç¦æ­¢å¯«é›»æ³¢ã€‚
            3. å›æ–‡ 8 å‰‡ã€‚æ ¼å¼ã€Œæ¨|å…§å®¹ã€ã€‚ç¦æ­¢å•è™Ÿçµå°¾ã€‚
            åˆ†æ®µè¼¸å‡ºã€‚"""
            
            try:
                raw_res = model.generate_content(prompt).text
                # ç°¡å–®åˆ†æ®µ
                st.subheader("å…§æ–‡ï¼š")
                body = raw_res.split("å›æ–‡")[0].replace("å…§æ–‡", "").strip()
                st.write(body.replace("\n", "  \n"))
                
                st.subheader("å›æ–‡ï¼š")
                cmts = raw_res.split("å›æ–‡")[-1].strip().split("\n")
                prefix = ["æ¨", "æ¨", "â†’", "â†’", "å™“"]
                for c in cmts:
                    c = re.sub(r'^[æ¨å™“â†’\|:\s\d\.-]+', '', c).strip()
                    if len(c) > 2:
                        st.write(f"{random.choice(prefix)}| {c.replace('?', '')}")
            except:
                st.error("æ’°å¯«å¤±æ•—ï¼Œè«‹é‡æ–°æŒ‰æŒ‰éˆ•")
