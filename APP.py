import streamlit as st
import google.generativeai as genai
import os
import random
import json
import requests

# --- 1. è¨­å®šé é¢ ---
st.set_page_config(page_title="PTT/Dcard æ–‡æ¡ˆç”¢ç”Ÿå™¨ (V42 å…¨æ–¹ä½ä»¿å¯«ç‰ˆ)", page_icon="ðŸ§¬")

api_key = st.secrets.get("GOOGLE_API_KEY")

st.title("ðŸ§¬ PTT/Dcard æ–‡æ¡ˆç”¢ç”Ÿå™¨ (V42 å…¨æ–¹ä½ä»¿å¯«ç‰ˆ)")

if not api_key:
    st.error("âŒ æ‰¾ä¸åˆ° API Keyï¼")
    st.stop()

genai.configure(api_key=api_key)

# --- 2. å…§å»ºå®Œæ•´è³‡æ–™åº« (å«å›žæ–‡) ---
DEFAULT_DATABASE = [
    {
        "title": "[è¨Žè«–] è½èªªæ‰“é™è§£é…¶æœƒé€£è‡ªå·±çš„è‚‰ä¸€èµ·æº¶æŽ‰?",
        "content": "æœ‹å‹å‰å…©å¹´åœ¨æ·šæºæ‰“äº†ä¸€æ”¯çŽ»å°¿é…¸ï¼Œæœ€è¿‘è¦ºå¾—çœ¼ä¸‹é€™å…©æ¢æ¯›æ¯›èŸ²è¶Šä¾†è¶Šæ˜Žé¡¯ã€‚è«®è©¢é†«ç”Ÿèªªè¦å…ˆé™è§£ï¼Œä½†çˆ¬æ–‡çœ‹åˆ°å¾ˆå¤šäººèªªé™è§£é…¶æœƒé€£è‡ªé«”çš„é€æ˜Žè³ªé…¸ä¸€èµ·æº¶æŽ‰ï¼Œå°Žè‡´çš®è†šè®Šè¶…ä¹¾ã€ç”šè‡³å‡¹é™·ï¼Ÿæƒ³å•ç‰ˆä¸Šæœ‰æ²’æœ‰äººæ‰“éŽï¼Ÿ",
        "comments": [
            "æŽ¨|çœ‹éŽæœ‰äººæ‰“å®Œæ·šæºç›´æŽ¥å‡¹ä¸€å¡Š é¤Šäº†åŠå¹´æ‰é•·å›žä¾†ä¸€é»žé»ž",
            "æŽ¨|é€™å¾ˆçœ‹é†«ç”ŸæŽ§åˆ¶æ¿ƒåº¦çš„æŠ€è¡“",
            "æŽ¨|æœƒå‡¹+1 é™è§£é…¶æ•µæˆ‘ä¸åˆ†çš„",
            "æŽ¨|åƒè¬ä¸è¦ä¸€æ¬¡æ‰“å¤ªå¤šå–®ä½",
            "æŽ¨|è½èªªçš®è†šè®Šå¾—å¾ˆè–„å¾ˆçšº åƒè€å¤ªå¤ªçš„çš®"
        ]
    },
    {
        "title": "[è¨Žè«–] é‡åŠ‘é†«ç¾Žæ ¹æœ¬æ˜¯ç„¡åº•æ´ž...ç®—å®Œå¹´è²»åš‡æ­»äºº",
        "content": "ä»¥å‰è¦ºå¾—å‹•æ‰‹è¡“è²´ï¼Œçµæžœè¨˜å¸³ç™¼ç¾é‡åŠ‘æ‰æ˜¯éŒ¢å‘ã€‚è‚‰æ¯’é™¤çšº+ç˜¦å°è‡‰ä¸€å¹´å¿«2è¬ï¼ŒçŽ»å°¿é…¸åŠå¹´æ¶ˆä¸€åŠåˆè¦è£œã€‚ç®—ä¸‹ä¾†ä¸€å¼µè‡‰æ¯å¹´çš„ã€Œç¶­è­·è²»ã€ç«Ÿç„¶è¦10å¹¾è¬ï¼é€™æ ¹æœ¬æ˜¯è¨‚é–±åˆ¶ï¼Œæ²’çºŒè²»å°±æ‰“å›žåŽŸå½¢ã€‚",
        "comments": [
            "æŽ¨|çœŸçš„...å¾®æ•´å°±æ˜¯è¨‚é–±åˆ¶ æ²’çºŒè²»å°±æ‰“å›žåŽŸå½¢",
            "æŽ¨|é€™å°±æ˜¯æº«æ°´ç…®é’è›™å•Š",
            "æŽ¨|ä½†ä¸ç¶­æŒåˆæœƒæœ‰ç„¦æ…®æ„Ÿ å·²ç¶“å›žä¸åŽ»æ²’æ‰“ä¹‹å‰çš„æ¨£å­äº†",
            "æŽ¨|é†«ç”Ÿæœ€æ„›æŽ¨é‡åŠ‘å•Š ç´°æ°´é•·æµ",
            "æŽ¨|ç®—å®Œä¸æ•¢é¢å°~é€™äº›éŒ¢æ‹¿åŽ»å­˜è‚¡æ—©å°±è²¡å¯Œè‡ªç”±äº†"
        ]
    },
    {
        "title": "[å•é¡Œ] ç‚ºäº†é¢ç›¸æ‹›è²¡åŽ»æ‰“è€³åž‚çŽ»å°¿é…¸?",
        "content": "æœ‹å‹å¤©ç”Ÿè€³åž‚è–„ï¼Œé•·è¼©èªªç•™ä¸ä½éŒ¢ï¼Œæƒ³åŽ»æ‰“çŽ»å°¿é…¸è®Šæˆæ‹›è²¡è€³ã€‚é›–ç„¶è½èµ·ä¾†è¿·ä¿¡ï¼Œä½†å¦‚æžœèƒ½æ”¹é‹å¥½åƒä¹Ÿå€¼å¾—ï¼Ÿä½†æ“”å¿ƒè€³åž‚ç¥žç¶“å¤šæœƒä¸æœƒè¶…ç—›ï¼Ÿ",
        "comments": [
            "æŽ¨|å¿ƒç†ä½œç”¨å±…å¤šå§ æŠŠæ‰“é‡çš„éŒ¢å­˜èµ·ä¾†å°±æ˜¯æ‹›è²¡äº†XD",
            "æŽ¨|çœ‹éŽæœ‰äººæ‰“å¤ªå¤§è®Šè¶…ç´šæ€ª",
            "æŽ¨|æœƒç—›åˆ°å¾€ç”Ÿå–”...è€³æœµç¥žç¶“è¶…å¤š åƒè¬åˆ¥è¼•æ˜“å˜—è©¦",
            "æŽ¨|å°å¿ƒæ‰“åˆ°è¡€ç®¡æ “å¡ž è€³æœµç™¼é»‘å°±çœŸçš„ç ´è²¡äº†",
            "æŽ¨|åªèƒ½èªªè®Šæ¼‚äº®å¿ƒæƒ…å¥½ é‹æ°£è‡ªç„¶å°±å¥½XD"
        ]
    },
    {
        "title": "[è¨Žè«–] æµ·å¤–é†«ç¾Žä¸€ç›´åœ¨è„†ä¸Šæ›å…‰åƒ¹æ ¼ å°ç£ç„¡æ³•å¯ç®¡å—Ž?",
        "content": "æœ€è¿‘æ»‘è„†è¢«éŸ“åœ‹è·Ÿä¸Šæµ·çš„é†«ç¾Žå»£å‘Šæ´—ç‰ˆï¼Œåƒ¹æ ¼é€æ˜Žé€£æ©Ÿç¥¨éƒ½æ•¢POã€‚åè§€å°ç£å—æ³•è¦é™åˆ¶é€£æŠ˜æ‰£éƒ½ä¸èƒ½è¬›æ˜Žã€‚æ”¿åºœæ˜¯ä¸æ˜¯æŸæ‰‹ç„¡ç­–ï¼Ÿå°ç£è¨ºæ‰€åªèƒ½ä¹–ä¹–è¢«æ‰“é‚„è¦è¢«ç½°éŒ¢ï¼Œæ„Ÿè¦ºå¾ˆæ…˜ã€‚",
        "comments": [
            "æŽ¨|è²ªå°ä¾¿å®œçš„å°±æœƒåŽ»é‚£ç¨®",
            "æŽ¨|é›£æ€ªç¾åœ¨é‚£éº¼å¤šäººè·‘åœ‹å¤–é†«ç¾Ž",
            "æŽ¨|å¦‚æžœé‡åˆ°ä»€éº¼å•é¡Œï¼Œå°ç£çš„æ¯”è¼ƒæœ‰æ³•å¾‹ä¿éšœ",
            "æŽ¨|å¥½å¥‡åœ‹å¤–éƒ½æ²’æœ‰é€™ç¨®æ³•è¦å—Ž?",
            "æŽ¨|åƒ¹æ ¼é€æ˜Žæœ‰æ™‚å€™ä¹Ÿä¸è¦‹å¾—åšå®Œä¸æœƒå¦å¤–æ”¶å–å…¶ä»–è²»ç”¨æ¬¸"
        ]
    },
    {
        "title": "[è¨Žè«–] é†«ç¾Žåšä¹…çœŸçš„æœƒå–ªå¤±å°æ­£å¸¸äººé•·ç›¸çš„åˆ¤æ–·åŠ›å—Ž?",
        "content": "è‡ªå¾žå…¥äº†é†«ç¾Žå‘ï¼Œå¯©ç¾Žè§€å¥½åƒå£žæŽ‰äº†ã€‚ç¾åœ¨çœ‹åˆ°è·¯äººç¬¬ä¸€çœ¼å°±æ˜¯åƒæŽƒææ©Ÿä¸€æ¨£çœ‹ç‘•ç–µï¼šã€Œæ·šæºå¥½æ·±ã€ã€ã€Œå’€åš¼è‚Œå¤ªå¤§ã€ã€‚æ˜¯ä¸æ˜¯åœ¨é€™å€‹åœˆå­å¾…ä¹…äº†ï¼Œå·²ç¶“å¿˜è¨˜ä»€éº¼æ˜¯ã€Œæ­£å¸¸äººé¡žã€è©²æœ‰çš„æ¨£å­äº†ï¼Ÿ",
        "comments": [
            "æŽ¨|çœŸçš„æœƒæœ‰ã€Œé†«ç¾Žæˆç™®ç—‡ã€ å®¹è²Œç„¦æ…®æœƒç„¡é™æ”¾å¤§ç‘•ç–µ",
            "æŽ¨|æˆ‘çœ‹å¾ˆå¤šè«®è©¢å¸«æ•´å¼µè‡‰éƒ½é¥…åŒ–äº† é‚„è¦ºå¾—è‡ªå·±å¾ˆç¾ŽXD",
            "æŽ¨|é€™å°±æ˜¯ç‚ºä»€éº¼è·¯ä¸Šè¤‡è£½äººè¶Šä¾†è¶Šå¤š",
            "æŽ¨|é†«ç”Ÿå¦‚æžœæœ‰è‰¯å¿ƒæœƒå‹¸é€€å¦³",
            "æŽ¨|çœŸçš„...æˆ‘ç¾åœ¨é€£çœ‹éŸ“åŠ‡éƒ½åœ¨ç ”ç©¶å¥³ä¸»è§’å“ªè£¡æœ‰å‹•XD"
        ]
    },
    {
        "title": "[è¨Žè«–] å°ç´…æ›¸éƒ½åœ¨æŽ¨è¼ªå»“å›ºå®š åˆ°åº•æ˜¯ä»€éº¼æ–°ç™‚ç¨‹?",
        "content": "æ»‘å°ç´…æ›¸ä¸€ç›´è¢«ã€Œè¼ªå»“å›ºå®šã€æ´—ç‰ˆï¼Œèªªåšå®Œè‡‰æœƒè®Šå°è®Šç²¾ç·»ã€‚å•äº†å°ç£è¨ºæ‰€å¥½åƒæ²’é€™é …ç›®ï¼Œé€™åˆ°åº•æ˜¯æ–°æŠ€è¡“é‚„æ˜¯åªæ˜¯çŽ»å°¿é…¸æ›åå­—åŒ…è£ï¼Ÿè½èªªä¸€æ¬¡è¦æ‰“åå¹¾æ”¯é‡æ˜¯çœŸçš„å—Žï¼Ÿ",
        "comments": [
            "æŽ¨|è¦æ‹‰æç·Šç·»æ€Žéº¼ä¸æ‰“é›»éŸ³æ³¢å°±å¥½",
            "æŽ¨|è½èªªè·ŸåŸºåº•æ”¯æ’å¾ˆåƒ é€™å€‹åå­—ä¸æ˜¯å¾ˆä¹…äº†å—Ž?",
            "æŽ¨|å®ƒä¸»è¦æ˜¯é‡å°å…§å¤–è¼ªå»“åŽ»åšä¸€å€‹æ”¯æ’ã€æ‹‰æè·Ÿå¡«è£œ",
            "æŽ¨|å°ç´…æ›¸éƒ½å¾ˆå¤§é™¸ç”¨èªžï¼Œæ„Ÿè¦ºä¸å¤ªå¯é ",
            "æŽ¨|å¦‚æžœæ˜¯å…¨è‡‰æ”¹å–„è²»ç”¨ä¸€å®šä¸ä¾¿å®œ"
        ]
    },
    {
        "title": "[è¨Žè«–] éŸ“ç‰ˆé›»æ³¢çœŸçš„æ˜¯å¹³æ›¿?é‚„æ˜¯é‚£æ˜¯çµ¦çª®äººæ‰“çš„å®‰æ…°åŠ‘",
        "content": "ç¾Žåœ‹é›»æ³¢æ¼²å¤ªå…‡ï¼Œè¨ºæ‰€ç‹‚æŽ¨éŸ“ç‰ˆé›»æ³¢ï¼Œåƒ¹æ ¼åªè¦1/3ã€‚å¤§å®¶éƒ½èªªCPå€¼é«˜ï¼Œä½†æˆ‘å¿ƒè£¡ç–‘å•ä¸€åˆ†éŒ¢ä¸€åˆ†è²¨ï¼Œå¦‚æžœæ•ˆæžœå·®ä¸å¤šé³³å‡°æ€Žéº¼æ²’å€’ï¼ŸéŸ“ç‰ˆåˆ°åº•æ˜¯çœŸå¹³æ›¿ï¼Œé‚„æ˜¯åªæ˜¯æ‰“å€‹å¿ƒå®‰çš„å®‰æ…°åŠ‘ï¼Ÿ",
        "comments": [
            "æŽ¨|æ‰“éŽçŽ©ç¾Ž çœŸçš„å°±æ˜¯å®‰æ…°åŠ‘...",
            "æŽ¨|ä¸€åˆ†éŒ¢ä¸€åˆ†è²¨ é³³å‡°ç—›æ­¸ç—›",
            "æŽ¨|éŸ“ç‰ˆé©åˆ25æ­²å·¦å³ç•¶ä¿é¤Š",
            "æŽ¨|é³³å‡°è²´åœ¨å°ˆåˆ©è·Ÿé‚£å€‹å†·åª’å™´å°„æŠ€è¡“ éŸ“ç‰ˆçœŸçš„å¾ˆåƒç†±çŸ³æŒ‰æ‘©XD",
            "æŽ¨|æƒ³çœéŒ¢å°±æ‰“éŸ“ç‰ˆ æƒ³é€†é½¡é‚„æ˜¯ä¹–ä¹–åˆ·å¡æ‰“é³³å‡°å§"
        ]
    },
    {
        "title": "[è¨Žè«–] ç”·ç”Ÿèªªå–œæ­¡è‡ªç„¶ç¾Žå¥³ å…¶å¯¦æ ¹æœ¬åˆ†ä¸å‡ºä¾†å§",
        "content": "å¸¸è½åˆ°ç”·ç”Ÿèªªå–œæ­¡è‡ªç„¶çš„ï¼Œçµæžœè½‰é ­ç‹‚è®šIGç¶²ç¾Žã€‚ä½†æˆ‘ä»”ç´°çœ‹é‚£äº›å¥³ç”Ÿæ˜Žæ˜Žéƒ½æœ‰å‹•ï¼Œåªæ˜¯åšå¾—å¾ˆé«˜éšŽã€‚æ˜¯ä¸æ˜¯å°ç›´ç”·ä¾†èªªï¼Œåªè¦æ²’è®Šæˆè›‡ç²¾è‡‰ï¼Œçœ‹ä¸å‡ºç—•è·¡çš„çµ±çµ±ç®—å¤©ç„¶ï¼Ÿ",
        "comments": [
            "æŽ¨|çœŸçš„ é€£ç´ é¡è·Ÿæ·¡å¦éƒ½åˆ†ä¸å‡ºä¾†äº† ä½•æ³æ˜¯é«˜éšŽé†«ç¾Ž",
            "æŽ¨|åªè¦æ¼‚äº®é †çœ¼ä»–å€‘å°±è¦ºå¾—æ˜¯å¤©ç„¶",
            "æŽ¨|é€™å°±æ˜¯é‡‘éŒ¢çš„åŠ›é‡ è²´çš„é†«ç¾Žå°±æ˜¯è®“ä½ è®Šç¾Žä½†çœ‹ä¸å‡ºä¾†",
            "æŽ¨|æˆ‘ç¸«é›™çœ¼çš®æ¶ˆè…«å¾Œ ç”·å‹é‚„ä»¥ç‚ºæˆ‘æ˜¯è²¼é›™çœ¼çš®è²¼è®Šæ°¸ä¹…çš„...",
            "æŽ¨|å¾ˆå¤šéŸ“æ˜Ÿä¹Ÿæ˜¯æ•´å¾—è¶…è‡ªç„¶ ç”·ç”Ÿé‚„ä¸æ˜¯æ„›å¾—è¦æ­»"
        ]
    }
]

# --- 3. é›²ç«¯æŠ“å–åŠŸèƒ½ ---
@st.cache_data(ttl=600)
def fetch_remote_data(url):
    if not url: return []
    try:
        response = requests.get(url)
        if response.status_code == 200:
            return json.loads(response.text)
    except:
        return []
    return []

# --- 4. å–å¾—æ¨¡åž‹æ¸…å–® ---
@st.cache_resource
def get_all_models():
    try:
        models = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        def sort_priority(name):
            if "gemini-1.5-pro" in name and "exp" not in name: return 0
            if "gemini-pro" in name: return 1
            return 10
        models.sort(key=sort_priority)
        return models
    except:
        return ["models/gemini-1.5-pro", "models/gemini-pro"]

all_my_models = get_all_models()

# --- 5. å´é‚Šæ¬„ ---
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    selected_model_name = st.selectbox("ðŸ‘‡ é¸æ“‡æ¨¡åž‹ï¼š", all_my_models, index=0)
    
    st.divider()
    st.header("â˜ï¸ è³‡æ–™åº«")
    data_url = st.text_input("JSON è³‡æ–™ç¶²å€ (é¸å¡«)ï¼š", placeholder="https://raw.githubusercontent...")
    
    final_database = DEFAULT_DATABASE
    if data_url:
        remote_data = fetch_remote_data(data_url)
        if remote_data:
            final_database = remote_data
            st.success(f"âœ… é›²ç«¯è³‡æ–™ï¼š{len(final_database)} ç¯‡")
        else:
            st.error("âŒ è®€å–å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºè³‡æ–™")
    else:
        st.info(f"ðŸ“š å…§å»ºè³‡æ–™ï¼š{len(final_database)} ç¯‡")

model = genai.GenerativeModel(selected_model_name)

# å®‰å…¨è¨­å®š
safe_settings = [
    {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
    {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
    {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
    {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
]

# --- 6. ä¸»ä»‹é¢ ---
if 'used_titles' not in st.session_state: st.session_state.used_titles = set()
if 'candidate_titles' not in st.session_state: st.session_state.candidate_titles = []

col1, col2 = st.columns(2)

with col1:
    st.subheader("ðŸ“Œ æ¨™é¡Œåˆ†é¡ž")
    ptt_tag = st.selectbox("é¸æ“‡æ¨™ç±¤ï¼š", ["[å•é¡Œ]", "[è¨Žè«–]", "[å¿ƒå¾—]", "[é–’èŠ]", "[é»‘ç‰¹]", "ðŸŽ² éš¨æ©Ÿ"])
    topic_category = st.selectbox("è­°é¡Œå…§å®¹ï¼š", ["ðŸ’‰ é‡åŠ‘/å¾®æ•´", "âš¡ é›»éŸ³æ³¢/é›·å°„", "ðŸ¥ é†«ç¾Žè¨ºæ‰€/é»‘å¹•", "ðŸ”ª æ•´å½¢æ‰‹è¡“", "âœï¸ è‡ªè¨‚ä¸»é¡Œ"])
    
    if "è‡ªè¨‚" in topic_category:
        user_topic = st.text_input("è¼¸å…¥è‡ªè¨‚ä¸»é¡Œï¼š", "éŸ“ç‰ˆé›»æ³¢æ˜¯æ™ºå•†ç¨…å—Žï¼Ÿ")
    else:
        user_topic = f"é—œæ–¼ã€Œ{topic_category.split('(')[0]}ã€çš„è¨Žè«–"

with col2:
    st.subheader("ðŸ”¥ è¨­å®š")
    tone_intensity = st.select_slider("å¼·åº¦ï¼š", ["æº«å’Œ", "ç†±çƒˆ", "ç‚Žä¸Š"], value="ç†±çƒˆ")
    
    st.markdown("---")
    if st.button("ðŸš€ ç”Ÿæˆ 5 å€‹æ¨™é¡Œ", use_container_width=True):
        
        # éš¨æ©ŸæŠ½å– 3 å€‹æ¨™é¡Œç¯„ä¾‹
        sample_size = min(len(final_database), 3)
        examples = random.sample(final_database, sample_size)
        example_text = "\n".join([f"- {ex['title']}" for ex in examples])
        
        with st.spinner(f"æ­£åœ¨åƒè€ƒè³‡æ–™åº«..."):
            try:
                target_tag = ptt_tag.split(" ")[0] if "éš¨æ©Ÿ" not in ptt_tag else "[å•é¡Œ]"
                prompt = f"""
                ä½ æ˜¯ä¸€å€‹ PTT é†«ç¾Žç‰ˆè³‡æ·±é„‰æ°‘ã€‚
                è«‹åƒè€ƒä»¥ä¸‹ã€çœŸå¯¦è³‡æ–™åº«æ¨™é¡Œã€‘çš„ä¸‹æ¨™é‚è¼¯ï¼š
                {example_text}
                
                ä»»å‹™ï¼šç‚ºä¸»é¡Œã€Œ{user_topic}ã€ç™¼æƒ³ 10 å€‹æ–°æ¨™é¡Œã€‚
                é™åˆ¶ï¼šä»¥ã€Œ{target_tag}ã€é–‹é ­ï¼Œå­—æ•¸ 16~22 å­— (ä¸å«æ¨™ç±¤)ï¼Œèªžæ°£ï¼š{tone_intensity}ã€‚
                ä¸€è¡Œä¸€å€‹ï¼Œä¸è¦ç·¨è™Ÿã€‚
                """
                response = model.generate_content(prompt, safety_settings=safe_settings)
                titles = response.text.strip().split('\n')
                st.session_state.candidate_titles = [t.strip() for t in titles if t.strip()][:5]
            except Exception as e:
                st.error("ç”Ÿæˆå¤±æ•—")
                st.code(str(e))

# --- 7. çµæžœèˆ‡å…§æ–‡å€ ---
if st.session_state.candidate_titles:
    st.markdown("### ðŸ‘‡ ç”Ÿæˆçµæžœ (é»žæ“ŠæŽ¡ç”¨)")
    for i, t in enumerate(st.session_state.candidate_titles):
        if st.button(t, key=f"btn_{i}", use_container_width=True):
            st.session_state.sel_title = t
            st.session_state.candidate_titles = []
            st.rerun()

if 'sel_title' in st.session_state:
    st.divider()
    st.markdown(f"## ðŸ“ æ¨™é¡Œï¼š{st.session_state.sel_title}")
    
    with st.expander("ç½®å…¥è¨­å®š (é¸å¡«)"):
        is_promo = st.checkbox("é–‹å•Ÿç½®å…¥")
        prod_info = st.text_input("ç”¢å“è³‡è¨Š", "XXè¨ºæ‰€")

    if st.button("âœï¸ æ’°å¯«å…§æ–‡ (å…¨æ–¹ä½ä»¿å¯«æ¨¡å¼)"):
        with st.spinner("æ­£åœ¨æ¨¡ä»¿çœŸå¯¦é„‰æ°‘å£å»..."):
            try:
                # éš¨æ©ŸæŠ½å– 1 ç¯‡å®Œæ•´æ–‡ç«  (å«å›žæ–‡) ç•¶ä½œæŒ‡å°Ž
                ref_article = random.choice(final_database)
                ref_comments_str = "\n".join(ref_article.get("comments", []))
                
                # --- 1. å¯«å…§æ–‡ ---
                body_prompt = f"""
                ä½ æ˜¯ä¸€å€‹ PTT é†«ç¾Žç‰ˆé„‰æ°‘ã€‚
                è«‹æ¨¡ä»¿é€™ç¯‡ã€çœŸå¯¦ç¯„æ–‡ã€‘çš„é¢¨æ ¼å¯«ä½œï¼š
                æ¨™é¡Œï¼š{ref_article['title']}
                å…§æ–‡ï¼š{ref_article['content']}
                
                ç¾åœ¨è«‹å¯«ä¸€ç¯‡é—œæ–¼ã€Œ{user_topic}ã€çš„æ–‡ç« ã€‚
                æ¨™é¡Œï¼š{st.session_state.sel_title}
                è¦æ±‚ï¼šå­—æ•¸ç´„ 100-150 å­—ï¼Œç¬¬ä¸€äººç¨±ï¼Œå£èªžåŒ– (çœŸçš„...ã€==)ã€‚
                """
                body_response = model.generate_content(body_prompt, safety_settings=safe_settings).text
                
                # --- 2. å¯«å›žæ–‡ (åŠ å…¥çœŸå¯¦å›žæ–‡åƒè€ƒ) ---
                comment_prompt = f"""
                ä½ æ˜¯ä¸€å€‹ PTT é„‰æ°‘ã€‚
                è«‹åƒè€ƒä»¥ä¸‹ã€çœŸå¯¦å›žæ–‡é¢¨æ ¼ã€‘ï¼Œç”Ÿæˆé‡å°é€™ç¯‡æ–‡ç« çš„ 8 å‰‡ç•™è¨€ï¼š
                
                ã€çœŸå¯¦å›žæ–‡åƒè€ƒã€‘ï¼š
                {ref_comments_str}
                
                ã€ä½ çš„ä»»å‹™ã€‘ï¼š
                é‡å°æ–‡ç« ï¼š"{body_response}"
                ç”Ÿæˆ 8 å‰‡é¡žä¼¼é¢¨æ ¼çš„å›žæ–‡ã€‚
                è¦æ±‚ï¼š
                1. æ¯è¡Œé–‹é ­å¿…é ˆæ˜¯ `æŽ¨|`ã€‚
                2. ä¸è¦ IDã€‚
                3. èªžæ°£è¦åƒä¸Šé¢çš„åƒè€ƒç¯„ä¾‹ä¸€æ¨£é…¸ã€ç°¡çŸ­æˆ–ä¸­è‚¯ã€‚
                {f"ã€ç½®å…¥ã€‘ï¼šè«‹åœ¨ 1 å‰‡å›žæ–‡è‡ªç„¶æåˆ°ã€Œ{prod_info}ã€ã€‚" if is_promo else ""}
                """
                comment_response = model.generate_content(comment_prompt, safety_settings=safe_settings).text
                
                # --- é¡¯ç¤º ---
                st.subheader("å…§æ–‡ï¼š")
                st.markdown(body_response.replace("\n", "  \n")) 
                
                st.subheader("å›žæ–‡ï¼š")
                comments = comment_response.strip().split('\n')
                formatted_comments = ""
                for c in comments:
                    c = c.strip()
                    if c:
                        if any(x in c for x in ["æŽ¨|"]):
                             formatted_comments += c + "  \n"
                        elif len(c) > 2: 
                             formatted_comments += f"â†’| {c}  \n"

                st.markdown(formatted_comments)
                
            except Exception as e:
                st.error("æ’°å¯«å¤±æ•—")
                st.code(str(e))
