import streamlit as st
import google.generativeai as genai
import os
import random
import json
import requests
import re

# --- 1. è¨­å®šé é¢ ---
st.set_page_config(page_title="PTT/Dcard æ–‡æ¡ˆç”¢ç”Ÿå™¨ (V49 æ·±åº¦å°é½Šç‰ˆ)", page_icon="ðŸŽ¯")

api_key = st.secrets.get("GOOGLE_API_KEY")
st.title("ðŸŽ¯ PTT/Dcard æ–‡æ¡ˆç”¢ç”Ÿå™¨ (V49 æ·±åº¦å°é½Šç‰ˆ)")

if not api_key:
    st.error("âŒ æ‰¾ä¸åˆ° API Keyï¼")
    st.stop()

genai.configure(api_key=api_key)

# --- 2. æ ¸å¿ƒè³‡æ–™åº« (åš´æ ¼ä¾ç…§æä¾›æª”æ¡ˆæ•´ç†) ---
DB = [
    {
        "category": "âš¡ é›»éŸ³æ³¢/é›·å°„",
        "title": "[è¨Žè«–] éŸ“ç‰ˆé›»æ³¢çœŸçš„æ˜¯å¹³æ›¿?é‚„æ˜¯é‚£æ˜¯çµ¦çª®äººæ‰“çš„å®‰æ…°åŠ‘",
        "content": "ç¾Žåœ‹é›»æ³¢å¯¦åœ¨æ¼²å¤ªå…‡ æ‰“ä¸€æ¬¡900ç™¼éƒ½è¦å¿«10è¬ã€‚çœ‹åˆ°å¾ˆå¤šè¨ºæ‰€ç‹‚æŽ¨éŸ“ç‰ˆé›»æ³¢ï¼Œåƒ¹æ ¼å¤§æ¦‚åªè¦1/3ç”šè‡³æ›´ä½Žã€‚å¤§å®¶éƒ½èªªæ•ˆæžœå·®ä¸å¤šã€CPå€¼å¾ˆé«˜ã€‚ä½†æˆ‘å¿ƒè£¡ç–‘å•ï¼Œä¸€åˆ†éŒ¢ä¸€åˆ†è²¨ï¼Œå¦‚æžœæ•ˆæžœçœŸçš„å·®ä¸å¤šï¼Œé³³å‡°æ€Žéº¼é‚„æ²’å€’ï¼ŸéŸ“ç‰ˆåˆ°åº•æ˜¯çœŸå¹³æ›¿ï¼Œé‚„æ˜¯åªæ˜¯æ‰“å€‹å¿ƒå®‰çš„å®‰æ…°åŠ‘?",
        "comments": ["æŽ¨|æ‰“éŽçŽ©ç¾Ž çœŸçš„å°±æ˜¯å®‰æ…°åŠ‘...", "æŽ¨|ä¸€åˆ†éŒ¢ä¸€åˆ†è²¨ é³³å‡°ç—›æ­¸ç—›", "æŽ¨|é³³å‡°è²´åœ¨å°ˆåˆ©è·Ÿå†·åª’æŠ€è¡“ éŸ“ç‰ˆçœŸçš„å¾ˆåƒç†±çŸ³æŒ‰æ‘©XD", "æŽ¨|æƒ³çœéŒ¢å°±æ‰“éŸ“ç‰ˆ æƒ³é€†é½¡é‚„æ˜¯ä¹–ä¹–åˆ·å¡æ‰“é³³å‡°å§"]
    },
    {
        "category": "ðŸ’‰ é‡åŠ‘/å¾®æ•´",
        "title": "[è¨Žè«–] é‡åŠ‘é†«ç¾Žæ ¹æœ¬æ˜¯ç„¡åº•æ´ž...ç®—å®Œå¹´è²»åš‡æ­»äºº",
        "content": "ä»¥å‰è¦ºå¾—å‹•æ‰‹è¡“è²´ï¼Œæ‰€ä»¥åšå¾®æ•´ã€‚çµæžœç™¼ç¾é‡åŠ‘æ‰æ˜¯çœŸæ­£çš„éŒ¢å‘QQã€‚è‚‰æ¯’é™¤çšº+ç˜¦å°è‡‰ä¸€å¹´2-3æ¬¡ï¼ŒçŽ»å°¿é…¸åŠå¹´æ¶ˆä¸€åŠåˆè¦è£œã€‚ç®—ä¸‹ä¾†ä¸€å¼µè‡‰æ¯å¹´çš„ã€Œç¶­è­·è²»ã€ç«Ÿç„¶è¦10å¹¾è¬ï¼è€Œä¸”æ˜¯æ¯å¹´éƒ½è¦ä»˜ï¼å¤§å®¶æœ‰ç®—éŽè‡ªå·±çš„è‡‰éƒ¨å¹´è²»å—Ž?",
        "comments": ["æŽ¨|çœŸçš„...å¾®æ•´å°±æ˜¯è¨‚é–±åˆ¶ æ²’çºŒè²»å°±æ‰“å›žåŽŸå½¢", "æŽ¨|é€™å°±æ˜¯æº«æ°´ç…®é’è›™å•Š", "æŽ¨|ä½†ä¸ç¶­æŒåˆæœƒæœ‰ç„¦æ…®æ„Ÿ å·²ç¶“å›žä¸åŽ»æ²’æ‰“ä¹‹å‰çš„æ¨£å­äº†", "æŽ¨|æ‰€ä»¥é†«ç”Ÿæœ€æ„›æŽ¨é‡åŠ‘å•Š ç´°æ°´é•·æµ"]
    },
    {
        "category": "ðŸ¥ é†«ç¾Žè¨ºæ‰€/é»‘å¹•",
        "title": "[è¨Žè«–] é†«ç¾Žåšä¹…çœŸçš„æœƒå–ªå¤±å°æ­£å¸¸äººé•·ç›¸çš„åˆ¤æ–·åŠ›å—Ž?",
        "content": "è‡ªå¾žå…¥äº†é†«ç¾Žå‘ï¼Œå¯©ç¾Žè§€å¥½åƒå£žæŽ‰äº†XDã€‚ç¾åœ¨çœ‹åˆ°è·¯äººç¬¬ä¸€çœ¼å°±æ˜¯åƒæŽƒææ©Ÿçœ‹ç‘•ç–µï¼šæ·šæºå¥½æ·±ã€å’€åš¼è‚Œå¤ªå¤§ã€é¡é ­å¤ªå¹³ã€‚æ˜¯ä¸æ˜¯åœ¨é€™å€‹åœˆå­å¾…ä¹…äº†ï¼Œå·²ç¶“å¿˜è¨˜ä»€éº¼æ˜¯ã€Œæ­£å¸¸äººé¡žã€è©²æœ‰çš„ç”Ÿç†æ§‹é€ äº†?",
        "comments": ["æŽ¨|çœŸçš„æœƒæœ‰ã€Œé†«ç¾Žæˆç™®ç—‡ã€ å®¹è²Œç„¦æ…®æœƒç„¡é™æ”¾å¤§ç‘•ç–µ", "æŽ¨|æˆ‘çœ‹å¾ˆå¤šè«®è©¢å¸«æ•´å¼µè‡‰éƒ½é¥…åŒ–äº† é‚„è¦ºå¾—è‡ªå·±å¾ˆç¾ŽXD", "æŽ¨|é€™å°±æ˜¯ç‚ºä»€éº¼è·¯ä¸Šè¤‡è£½äººè¶Šä¾†è¶Šå¤š", "æŽ¨|æœ‰æ™‚å€™ä¿ç•™ä¸€é»žç‘•ç–µæ‰æ˜¯å€‹äººç‰¹è‰²"]
    },
    {
        "category": "ðŸ’‰ é‡åŠ‘/å¾®æ•´",
        "title": "[è¨Žè«–] è½èªªæ‰“é™è§£é…¶æœƒé€£è‡ªå·±çš„è‚‰ä¸€èµ·æº¶æŽ‰?",
        "content": "è«®è©¢é†«ç”Ÿéƒ½èªªè¦å…ˆã€Œé™è§£ã€æŽ‰èˆŠçš„æ‰èƒ½é‡æ‰“ã€‚ä½†ä¸Šç¶²çˆ¬æ–‡çœ‹åˆ°å¾ˆå¤šäººèªªé™è§£é…¶ä¸åªæœƒæº¶çŽ»å°¿é…¸ï¼Œé‚„æœƒé€£è‡ªé«”çš„é€æ˜Žè³ªé…¸ä¸€èµ·æº¶æŽ‰ï¼Œå°Žè‡´çš®è†šè®Šè¶…ä¹¾ã€ç”šè‡³çœŸçš®å±¤èŽç¸®å‡¹é™·ï¼Œè®Šæˆä¸€å€‹å‘è£œä¸å›žä¾†!?çœŸçš„æœ‰å‚³èªªä¸­é€™éº¼å¯æ€•å—Ž?",
        "comments": ["æŽ¨|æœƒå‡¹+1 é™è§£é…¶æ•µæˆ‘ä¸åˆ†çš„", "æŽ¨|è½èªªçš®è†šè®Šå¾—å¾ˆè–„å¾ˆçšº åƒè€å¤ªå¤ªçš„çš®", "æŽ¨|å¦‚æžœæ˜¯æ‰“å¾ˆä¹…çš„çŽ»å°¿é…¸ å·²ç¶“è·Ÿçµ„ç¹”é•·åœ¨ä¸€èµ·äº† æº¶æŽ‰ç¢ºå¯¦æœƒç©ºç©ºçš„"]
    },
    {
        "category": "ðŸ’‰ é‡åŠ‘/å¾®æ•´",
        "title": "[å•é¡Œ] ç‚ºäº†é¢ç›¸æ‹›è²¡åŽ»æ‰“è€³åž‚çŽ»å°¿é…¸?",
        "content": "æœ‹å‹å¤©ç”Ÿè€³åž‚å¾ˆè–„åˆå°ï¼Œé•·è¼©éƒ½èªªé€™æ˜¯å‹žç¢Œå‘½ã€‚æƒ³èªªæ‰¾è¨ºæ‰€æ‰“è€³åž‚çŽ»å°¿é…¸ï¼Œæ‰“å‡ºåƒä½›ç¥–é‚£ç¨®é£½æ»¿çš„æ‹›è²¡è€³ã€‚é›–ç„¶è½èµ·ä¾†è¿·ä¿¡ï¼Œä½†å¦‚æžœèƒ½æ”¹é‹å¥½åƒä¹Ÿå€¼å¾—? ä½†æ“”å¿ƒè€³æœµç¥žç¶“å¤šæœƒä¸æœƒè¶…ç—›?",
        "comments": ["æŽ¨|å¿ƒç†ä½œç”¨å±…å¤šå§ æŠŠæ‰“é‡çš„éŒ¢å­˜èµ·ä¾†å°±æ˜¯æ‹›è²¡äº†XD", "æŽ¨|æœ‹å‹æœ‰æ‰“ï¼è²¡é‹æ²’æ„Ÿè¦ºä½†æˆ´è€³é£¾è®Šå¥½çœ‹", "æŽ¨|è€³åž‚æ²’è‚Œè‚‰ä¸å¤ªæœƒå‹• çŽ»å°¿é…¸å¯ä»¥æ’è¶…ä¹… CPå€¼ç®—é«˜"]
    }
]

# --- 3. æ¨¡åž‹æŠ“å– ---
@st.cache_resource
def get_best_model():
    try:
        models = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        priority = ["gemma-2", "gemini-1.5-pro", "gemini-pro"]
        for p in priority:
            for m in models:
                if p in m: return m
        return models[0]
    except: return "models/gemini-pro"

current_model_name = get_best_model()
model = genai.GenerativeModel(current_model_name)

# --- 4. ä¸»ä»‹é¢ ---
if 'candidate_titles' not in st.session_state: st.session_state.candidate_titles = []

st.sidebar.info(f"ä½¿ç”¨æ¨¡åž‹ï¼š{current_model_name}")

col1, col2 = st.columns(2)
with col1:
    ptt_tag = st.selectbox("æ¨™ç±¤ï¼š", ["[è¨Žè«–]", "[å•é¡Œ]", "[å¿ƒå¾—]", "[é–’èŠ]", "[é»‘ç‰¹]"])
    topic_category = st.selectbox("è­°é¡Œå…§å®¹ï¼š", ["ðŸ’‰ é‡åŠ‘/å¾®æ•´", "âš¡ é›»éŸ³æ³¢/é›·å°„", "ðŸ¥ é†«ç¾Žè¨ºæ‰€/é»‘å¹•", "ðŸ”ª æ•´å½¢æ‰‹è¡“"])
with col2:
    tone_intensity = st.select_slider("èªžæ°£ï¼š", ["æº«å’Œ", "ç†±çƒˆ", "ç‚Žä¸Š"], value="ç†±çƒˆ")

st.markdown("---")
imported_text = st.text_area("åŒ¯å…¥åŽŸæ–‡ (è‹¥æœ‰è²¼å…¥ï¼ŒAIæœƒä»¥æ­¤ç‚ºæ ¸å¿ƒæ”¹å¯«)ï¼š", height=80)

if st.button("ðŸš€ ç”Ÿæˆ 5 å€‹æ¨™é¡Œ", use_container_width=True):
    # éŽæ¿¾è³‡æ–™åº«ï¼Œåªæ‰¾ç›¸é—œçš„åƒè€ƒ
    ref_list = [d for d in DB if d["category"] == topic_category]
    if not ref_list: ref_list = DB
    examples = "\n".join([f"ç¯„ä¾‹æ¨™é¡Œï¼š{r['title']}" for r in random.sample(ref_list, min(2, len(ref_list)))])
    
    target_subject = imported_text if imported_text.strip() else topic_category
    
    prompt = f"""ä½ æ˜¯ä¸€å€‹PTTé„‰æ°‘ã€‚
    ã€åƒè€ƒç¯„æœ¬ã€‘ï¼š
    {examples}
    -------------------
    ã€ä»»å‹™ã€‘ï¼šé‡å°ã€Œ{target_subject}ã€å¯«5å€‹æ¨™é¡Œã€‚
    ã€è¦å‰‡ã€‘ï¼š
    1. å¿…é ˆæ˜¯ã€Œ{target_tag}ã€ã€‚
    2. ç¦æ­¢æŠ„è¥²ç¯„æœ¬å…§å®¹ï¼Œç¦æ­¢å¯«åˆ°ä¸ç›¸é—œçš„æ‰‹è¡“ã€‚
    3. æ¨™é¡Œè¦åƒäººè©±ï¼Œç¦æ­¢å†’è™Ÿï¼Œé•·åº¦18å­—å·¦å³ã€‚
    åªè¼¸å‡ºæ¨™é¡Œï¼Œä¸€è¡Œä¸€å€‹ã€‚"""
    
    try:
        res = model.generate_content(prompt).text.strip().split('\n')
        st.session_state.candidate_titles = [re.sub(r'^[\d\-\.\s]+', '', t).strip() for t in res if t.strip()][:5]
    except: st.error("ç”Ÿæˆå¤±æ•—")

if st.session_state.candidate_titles:
    st.markdown("### ðŸ‘‡ é¸æ“‡æ¨™é¡Œ")
    for i, t in enumerate(st.session_state.candidate_titles):
        if st.button(t, key=f"t_{i}", use_container_width=True):
            st.session_state.sel_title = t
            st.session_state.candidate_titles = []
            st.rerun()

if 'sel_title' in st.session_state:
    st.divider()
    st.markdown(f"## ðŸ“ æ¨™é¡Œï¼š{st.session_state.sel_title}")
    
    if st.button("âœï¸ æ’°å¯«å…§æ–‡ (V49 æ¨£æœ¬å°é½Šç‰ˆ)"):
        # å°‹æ‰¾æœ€åŒ¹é…çš„ç¯„æœ¬
        match = next((d for d in DB if d["category"] in st.session_state.sel_title or d["category"] == topic_category), DB[0])
        
        prompt = f"""ä½ æ˜¯PTTé„‰æ°‘ï¼Œè«‹æ¨¡ä»¿é€™ç¯‡ç¯„æ–‡å¯«ä½œã€‚
        ã€ç¯„æ–‡å…§å®¹ã€‘ï¼š
        æ¨™é¡Œï¼š{match['title']}
        å…§æ–‡ï¼š{match['content']}
        å›žæ–‡ç¯„ä¾‹ï¼š{match['comments'][0]}
        -------------------
        ã€ç¾åœ¨ä»»å‹™ã€‘ï¼š
        æ¨™é¡Œï¼š{st.session_state.sel_title}
        èªžæ°£ï¼š{tone_intensity}
        å…§å®¹ï¼š{imported_text if imported_text else topic_category}
        
        ã€è¦æ±‚ã€‘ï¼š
        1. å…§æ–‡120å­—ã€‚ç¦æ­¢æåˆ°ç„¡é—œçš„æ‰‹è¡“(å¦‚éš†ä¹³)ã€‚
        2. ç¦æ­¢å•å€™é–‹é ­ã€‚
        3. å›žæ–‡10å‰‡ã€‚æ ¼å¼ï¼šæŽ¨|å…§å®¹ã€‚ç¦æ­¢ä½¿ç”¨å•è™Ÿçµå°¾ã€‚
        å›žæ–‡è¦å…·é«”ï¼Œä¾‹å¦‚æåˆ°ã€Œå¹³æ›¿ã€ã€ã€Œç„¡åº•æ´žã€ã€ã€Œé¥…åŒ–ã€ã€‚"""
        
        try:
            res_text = model.generate_content(prompt).text
            # æ ¼å¼åŒ–è¼¸å‡º
            body = res_text.split("å›žæ–‡")[0].replace("å…§æ–‡", "").replace("ï¼š", "").strip()
            st.subheader("å…§æ–‡ï¼š")
            st.write(body.replace("\n", "  \n"))
            
            st.subheader("å›žæ–‡ï¼š")
            raw_comments = res_text.split("å›žæ–‡")[-1].strip().split("\n")
            for c in raw_comments:
                c = re.sub(r'^[æŽ¨å™“â†’\|:\s]+', '', c).strip()
                if len(c) > 2:
                    st.write(f"{random.choice(['æŽ¨','æŽ¨','â†’','å™“'])}| {c.replace('?', '').replace('ï¼Ÿ', '')}")
        except: st.error("æ’°å¯«å¤±æ•—")
