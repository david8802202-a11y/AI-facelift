import streamlit as st
import google.generativeai as genai
import random
import re

# --- 1. é é¢è¨­å®š ---
st.set_page_config(page_title="PTT æ–‡æ¡ˆç”¢ç”Ÿå™¨ V55", page_icon="ğŸ›¡ï¸")
api_key = st.secrets.get("GOOGLE_API_KEY")

if not api_key:
    st.error("âŒ æ‰¾ä¸åˆ° API Key")
    st.stop()

genai.configure(api_key=api_key)

# --- 2. æ·±åº¦çµæ§‹åŒ–è³‡æ–™åº« (åš´æ ¼ä¾ç…§æ‚¨çš„ 8 å€‹æª”æ¡ˆåˆ†é¡) ---
DB = {
    "ğŸ’‰ é‡åŠ‘/å¾®æ•´": {
        "topics": ["ç»å°¿é…¸å¡«è£œæ·šæº", "è‚‰æ¯’ç˜¦å°è‡‰", "æ¶ˆè„‚é‡å¿ƒå¾—", "ç²¾éˆé‡/ç«¥é¡é‡"],
        "examples": [
            {"title": "[è¨è«–] é‡åŠ‘é†«ç¾æ ¹æœ¬æ˜¯ç„¡åº•æ´...ç®—å®Œå¹´è²»åš‡æ­»äºº", "content": "å¾®æ•´å°±æ˜¯è¨‚é–±åˆ¶ï¼Œè‚‰æ¯’ç»å°¿é…¸åŠå¹´æ¶ˆä¸€åŠåˆè¦è£œï¼Œä¸€å¹´ç¶­è­·è²»ç«Ÿç„¶è¦10å¹¾è¬ï¼", "cmts": ["æ¨|å¾®æ•´å°±æ˜¯è¨‚é–±åˆ¶", "æ¨|é€™å°±æ˜¯æº«æ°´ç…®é’è›™å•Š", "æ¨|ç®—å®Œä¸æ•¢é¢å°ï¼ŒéŒ¢æ‹¿å»å­˜è‚¡æ—©è²¡å¯Œè‡ªç”±äº†"]},
            {"title": "[è¨è«–] è½èªªæ‰“é™è§£é…¶æœƒé€£è‡ªå·±çš„è‚‰ä¸€èµ·æº¶æ‰?", "content": "é™è§£é…¶ä¸åªæº¶ç»å°¿é…¸ï¼Œé‚„æœƒé€£è‡ªé«”çš„é€æ˜è³ªé…¸ä¸€èµ·æº¶æ‰ï¼Œå°è‡´çš®è†šè®Šä¹¾ã€èç¸®å‡¹é™·è®Šæˆä¸€å€‹å‘ï¼Ÿ", "cmts": ["æ¨|æœƒå‡¹+1 é™è§£é…¶æ•µæˆ‘ä¸åˆ†çš„", "æ¨|è½èªªçš®è†šè®Šå¾—å¾ˆè–„å¾ˆçšºï¼Œåƒè€å¤ªå¤ªçš„çš®", "æ¨|å¦‚æœæ˜¯æ‰“å¾ˆä¹…çš„ï¼Œæº¶æ‰ç¢ºå¯¦æœƒç©ºç©ºçš„"]},
            {"title": "[å•é¡Œ] ç‚ºäº†é¢ç›¸æ‹›è²¡å»æ‰“è€³å‚ç»å°¿é…¸?", "content": "å¤©ç”Ÿè€³å‚è–„è¢«èªªå‹ç¢Œå‘½ï¼Œæ‰“ç»å°¿é…¸è®Šä½›ç¥–æ‹›è²¡è€³å€¼å—ï¼Ÿæ“”å¿ƒè€³æœµç¥ç¶“å¤šæœƒè¶…ç—›ã€‚", "cmts": ["æ¨|æ‰“é‡çš„éŒ¢å­˜èµ·ä¾†å°±æ˜¯æ‹›è²¡äº†XD", "æ¨|æœƒç—›åˆ°å¾€ç”Ÿå–”...åƒè¬åˆ¥è¼•æ˜“å˜—è©¦", "æ¨|è€³å‚æ²’è‚Œè‚‰ç»å°¿é…¸å¯ä»¥æ’è¶…ä¹…"]}
        ]
    },
    "âš¡ é›»éŸ³æ³¢/é›·å°„": {
        "topics": ["é³³å‡°é›»æ³¢", "éŸ“ç‰ˆé›»æ³¢(ç©ç¾)", "çš®ç§’é›·å°„", "æµ·èŠ™éŸ³æ³¢"],
        "examples": [
            {"title": "[è¨è«–] éŸ“ç‰ˆé›»æ³¢çœŸçš„æ˜¯å¹³æ›¿?é‚„æ˜¯å®‰æ…°åŠ‘", "content": "é³³å‡°æ¼²åˆ°10è¬ï¼ŒéŸ“ç‰ˆåªè¦1/3ã€‚åˆ°åº•æ˜¯çœŸå¹³æ›¿ï¼Œé‚„æ˜¯åªæ˜¯æ‰“å€‹å¿ƒå®‰çš„å®‰æ…°åŠ‘?", "cmts": ["æ¨|æ‰“éç©ç¾ çœŸçš„å°±æ˜¯å®‰æ…°åŠ‘...", "æ¨|é³³å‡°è²´åœ¨å°ˆåˆ©ï¼ŒéŸ“ç‰ˆçœŸçš„å¾ˆåƒç†±çŸ³æŒ‰æ‘©XD", "æ¨|æƒ³é€†é½¡é‚„æ˜¯ä¹–ä¹–åˆ·å¡æ‰“é³³å‡°å§"]}
        ]
    },
    "ğŸ¥ é†«ç¾è¨ºæ‰€/é»‘å¹•": {
        "topics": ["å¯©ç¾è§€å–ªå¤±", "è«®è©¢å¸«é¥…åŒ–", "æµ·å¤–é†«ç¾å»£å‘Šåƒ¹æ ¼", "é†«ç™‚æ³•è¦"],
        "examples": [
            {"title": "[è¨è«–] é†«ç¾åšä¹…çœŸçš„æœƒå–ªå¤±å°æ­£å¸¸äººé•·ç›¸çš„åˆ¤æ–·åŠ›å—?", "content": "å¯©ç¾è§€å£æ‰äº†ï¼Œçœ‹è·¯äººéƒ½åœ¨çœ‹ç‘•ç–µã€‚æ˜¯ä¸æ˜¯å·²ç¶“å¿˜è¨˜æ­£å¸¸äººé¡è©²æœ‰çš„æ¨£å­äº†?", "cmts": ["æ¨|çœŸçš„æœƒæœ‰é†«ç¾æˆç™®ç—‡", "æ¨|çœ‹å¾ˆå¤šè«®è©¢å¸«æ•´å¼µè‡‰éƒ½é¥…åŒ–äº†é‚„è¦ºå¾—ç¾XD", "æ¨|è·¯ä¸Šè¤‡è£½äººè¶Šä¾†è¶Šå¤š"]},
            {"title": "[è¨è«–] æµ·å¤–é†«ç¾ä¸€ç›´åœ¨è„†ä¸Šæ›å…‰åƒ¹æ ¼ å°ç£ç„¡æ³•å¯ç®¡å—?", "content": "éŸ“åœ‹ä¸Šæµ·åƒ¹æ ¼é€æ˜é€£æ©Ÿç¥¨éƒ½POï¼Œå°ç£å—é™æ³•è¦ä¸èƒ½è¬›æŠ˜æ‰£ï¼Œé€™ä¸å…¬å¹³å§ï¼Ÿ", "cmts": ["æ¨|é›£æ€ªé‚£éº¼å¤šäººè·‘åœ‹å¤–é†«ç¾", "æ¨|é‡åˆ°å•é¡Œï¼Œå°ç£çš„æ¯”è¼ƒæœ‰æ³•å¾‹ä¿éšœ", "æ¨|åƒ¹æ ¼é€æ˜ä¸è¦‹å¾—æœ€å¾Œä¸æœƒæ”¶å…¶ä»–è²»ç”¨"]}
        ]
    },
    "ğŸ”ª æ•´å½¢æ‰‹è¡“": {
        "topics": ["éš†ä¹³æ‰‹è¡“å¿ƒå¾—", "éš†é¼»è®Šç´ç¾äºº", "æŠ½è„‚å¾Œéºç—‡", "å‰²/ç¸«é›™çœ¼çš®"],
        "examples": [
            {"title": "[è¨è«–] ç”·ç”Ÿèªªå–œæ­¡è‡ªç„¶ç¾å¥³ å…¶å¯¦æ ¹æœ¬åˆ†ä¸å‡ºä¾†å§", "content": "ç›´ç”·è¨å­çš„æ˜¯å¤±æ•—çš„æ•´å½¢ï¼Œåªè¦æ²’è®Šè›‡ç²¾è‡‰ï¼Œçœ‹ä¸å‡ºç—•è·¡çš„çµ±çµ±ç®—å¤©ç„¶ï¼Ÿ", "cmts": ["æ¨|é€£ç´ é¡æ·¡å¦éƒ½åˆ†ä¸å‡ºä¾†äº†", "æ¨|åªè¦æ¼‚äº®é †çœ¼ä»–å€‘å°±è¦ºå¾—æ˜¯å¤©ç„¶", "æ¨|è²´çš„é†«ç¾å°±æ˜¯è®“ä½ è®Šç¾ä½†çœ‹ä¸å‡ºä¾†"]}
        ]
    }
}

# --- 3. æ¨¡å‹é€£ç·š (é–å®šæœ€ç©©å®šç‰ˆ) ---
@st.cache_resource
def get_stable_model():
    # å˜—è©¦ 1.5-proï¼Œä¸è¡Œå‰‡ç”¨ pro
    available = [m.name for m in genai.list_models()]
    for m_name in ["gemini-1.5-pro", "gemini-pro"]:
        for a in available:
            if m_name in a: return genai.GenerativeModel(a)
    return genai.GenerativeModel("gemini-pro")

model = get_stable_model()

# --- 4. ä¸»ä»‹é¢ ---
if 'titles' not in st.session_state: st.session_state.titles = []

col1, col2 = st.columns(2)
with col1:
    tag = st.selectbox("æ¨™ç±¤ï¼š", ["[è¨è«–]", "[å•é¡Œ]", "[å¿ƒå¾—]", "[é–’èŠ]", "[é»‘ç‰¹]"])
    cat = st.selectbox("åˆ†é¡ï¼š", list(DB.keys()))
with col2:
    tone = st.select_slider("å¼·åº¦ï¼š", ["æº«å’Œ", "ç†±çƒˆ", "ç‚ä¸Š"], value="ç†±çƒˆ")

st.markdown("---")
imported = st.text_area("åŒ¯å…¥åŸæ–‡ (è‹¥æœ‰ï¼ŒAIæœƒä»¥æ­¤æ ¸å¿ƒæ”¹å¯«)ï¼š", height=100)

# --- 5. ç”Ÿæˆæ¨™é¡Œ ---
if st.button("ğŸš€ ç”Ÿæˆ 5 å€‹æ¨™é¡Œ", use_container_width=True):
    # å¼·åŠ›é–å®šä¸»é¡Œ
    core = imported.strip() if imported.strip() else random.choice(DB[cat]["topics"])
    ref = DB[cat]["examples"][0]["title"]
    
    prompt = f"""ä½ æ˜¯ PTT é†«ç¾ç‰ˆé„‰æ°‘ã€‚
    åƒè€ƒç¯„ä¾‹èªæ°£ï¼š{ref}
    ä»»å‹™ï¼šé‡å°ã€Œ{core}ã€å¯« 5 å€‹æ¨™é¡Œã€‚
    è¦æ±‚ï¼š
    1. æ ¼å¼å¿…é ˆæ˜¯ã€Œ{tag} å…§å®¹ã€ã€‚æ¨™é¡Œç›´æ¥è¬›é‡é»ï¼Œç¦æ­¢å†’è™Ÿã€‚
    2. ç¦æ­¢å¯«åˆ°ä»»ä½•èˆ‡ã€Œ{core}ã€ç„¡é—œçš„å…§å®¹ã€‚
    3. å­—æ•¸ 18 å­—å·¦å³ï¼ŒåƒçœŸäººèªªè©±ã€‚
    ä¸€è¡Œä¸€å€‹ã€‚"""

    try:
        res = model.generate_content(prompt).text.strip().split('\n')
        st.session_state.titles = [f"{tag} {re.sub(r'^.*?\]', '', t).strip()}" for t in res if t.strip()][:5]
    except:
        st.error("API æš«æ™‚ç¹å¿™ï¼Œè«‹å†æŒ‰ä¸€æ¬¡æŒ‰éˆ•")

# --- 6. é¸æ“‡èˆ‡æ’°å¯« ---
if st.session_state.titles:
    st.markdown("### ğŸ‘‡ é¸æ“‡æ¡ç”¨æ¨™é¡Œ")
    for i, t in enumerate(st.session_state.titles):
        if st.button(t, key=f"t_{i}", use_container_width=True):
            st.session_state.sel = t
            st.session_state.titles = []
            st.rerun()

if 'sel' in st.session_state:
    st.divider()
    st.subheader(f"ğŸ“ {st.session_state.sel}")
    
    if st.button("âœï¸ æ’°å¯«å®Œæ•´å…§æ–‡èˆ‡æ¨æ–‡"):
        with st.spinner("æ­£åœ¨å°é½Šç¯„æœ¬é¢¨æ ¼..."):
            # å–å¾—è©²åˆ†é¡å”¯ä¸€çš„åƒè€ƒç¯„ä¾‹
            match = DB[cat]["examples"][0]
            
            prompt = f"""ä½ æ˜¯ä¸€å€‹ PTT é„‰æ°‘ã€‚
            æ¨¡ä»¿é€™ç¯‡ç¯„æ–‡çš„å£å»ï¼š
            æ¨™é¡Œç¯„ä¾‹ï¼š{match['title']}
            å…§æ–‡ç¯„ä¾‹ï¼š{match['content']}
            
            ç¾åœ¨è«‹å¯«ï¼š
            æ¨™é¡Œï¼š{st.session_state.sel}
            ç´ æï¼š{imported if imported else cat}
            
            è¦æ±‚ï¼š
            1. å…§æ–‡ 120 å­—ï¼Œå£èªåŒ–ï¼Œç¬¬ä¸€äººç¨±ï¼Œç¦æ­¢é–‹é ­å•å€™ã€‚
            2. å…§å®¹åš´æ ¼å°é½Šæ¨™é¡Œã€‚æ¨™é¡Œæ˜¯æ‰‹è¡“å°±å¯«æ‰‹è¡“ï¼Œç¦æ­¢å¯«é›»æ³¢ã€‚
            3. å›æ–‡ 8 å‰‡ã€‚æ ¼å¼ã€Œæ¨|å…§å®¹ã€ã€‚ç¦æ­¢å•è™Ÿçµå°¾ã€‚
            å›æ–‡å…§å®¹è¦åƒé…¸æ°‘ã€ä¸­è‚¯æˆ–ç¶“é©—åˆ†äº«ã€‚
            åˆ†æ®µè¼¸å‡ºã€Œå…§æ–‡ï¼šã€èˆ‡ã€Œå›æ–‡ï¼šã€ã€‚"""
            
            try:
                raw_res = model.generate_content(prompt).text
                parts = raw_res.split("å›æ–‡")
                body = parts[0].replace("å…§æ–‡", "").replace("ï¼š", "").strip()
                
                st.markdown("#### å…§æ–‡ï¼š")
                st.write(body.replace("\n", "  \n"))
                
                st.markdown("#### å›æ–‡ï¼š")
                cmts = parts[-1].strip().split("\n")
                prefix = ["æ¨", "æ¨", "â†’", "â†’", "å™“"]
                for c in cmts:
                    c = re.sub(r'^[æ¨å™“â†’\|:\s\d\.-]+', '', c).strip()
                    if len(c) > 2:
                        st.write(f"{random.choice(prefix)}| {c.replace('?', '')}")
            except:
                st.error("é€£ç·šè¶…æ™‚ï¼Œè«‹é»æ“ŠæŒ‰éˆ•é‡è©¦")
