import streamlit as st
import google.generativeai as genai

# --- 1. è¨­å®šé é¢ ---
st.set_page_config(page_title="PTTé†«ç¾æ–‡æ¡ˆç”¢ç”Ÿå™¨ V2", page_icon="ğŸ’‰")

# --- 2. è®€å– API Key ---
api_key = st.secrets.get("GOOGLE_API_KEY")

if not api_key:
    st.error("âŒ æ‰¾ä¸åˆ° API Keyï¼è«‹æª¢æŸ¥ Streamlit çš„ Secrets è¨­å®šã€‚")
    st.stop()

# --- 3. è¨­å®š Google AI ---
genai.configure(api_key=api_key)

# å˜—è©¦ä½¿ç”¨å¤šç¨®æ¨¡å‹ï¼Œç¢ºä¿ç©©å®šæ€§
try:
    # å„ªå…ˆå˜—è©¦ Flash (é€Ÿåº¦å¿«)
    model = genai.GenerativeModel('gemini-1.5-flash')
    response = model.generate_content("test")
except Exception:
    try:
        # å‚™æ¡ˆ Pro
        model = genai.GenerativeModel('gemini-1.5-pro')
    except Exception:
        # æœ€çµ‚å‚™æ¡ˆ (èˆŠç‰ˆä½†ç©©å®š)
        model = genai.GenerativeModel('gemini-pro')

# --- 4. ç³»çµ±æç¤ºè© (AI çš„äººè¨­) ---
SYSTEM_INSTRUCTION = """
ä½ æ˜¯ä¸€å€‹ç²¾é€šå°ç£ PTT (æ‰¹è¸¢è¸¢å¯¦æ¥­åŠ) èˆ‡ Dcard æ–‡åŒ–çš„è³‡æ·±é„‰æ°‘ï¼ŒåŒæ™‚ä¹Ÿæ˜¯å°ˆæ¥­çš„é†«ç¾è¡ŒéŠ·æ–‡æ¡ˆå¯«æ‰‹ã€‚
ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½¿ç”¨è€…çš„éœ€æ±‚ï¼Œæ’°å¯«æ¥µå…·å¸å¼•åŠ›çš„æ–‡ç« ã€‚

ã€æ ¸å¿ƒåŸå‰‡ã€‘ï¼š
1. **çœŸå¯¦æ„Ÿ**ï¼šä¸è¦åƒæ©Ÿå™¨äººï¼Œè¦æœ‰ã€Œäººå‘³ã€ï¼ŒåŒ…å«èªåŠ©è©ã€æƒ…ç·’ç™¼æ´©ã€‚
2. **å¤šæ¨£æ€§**ï¼šç•¶è¦æ±‚ç”Ÿæˆå¤šå€‹æ¨™é¡Œæ™‚ï¼Œå‹™å¿…å¾ã€Œä¸åŒåˆ‡è§’ã€åˆ‡å…¥ï¼ˆå¦‚ï¼šé‡‘éŒ¢è§€ã€å¯©ç¾è§€ã€è¡“å¾Œç—›è‹¦ã€å…«å¦ã€æŠ€è¡“é¢ï¼‰ï¼Œåš´ç¦é‡è¤‡é¡ä¼¼çš„ä¸»é¡Œã€‚
"""

# --- 5. ç¶²é ä»‹é¢ ---
st.title("ğŸ’‰ PTT/Dcard é†«ç¾æ–‡æ¡ˆç”Ÿæˆå™¨ V2.0")
st.caption("æ–°å¢åŠŸèƒ½ï¼šèªæ°£å¼·åº¦èª¿æ•´ç›¤ã€è­°é¡Œå¤šæ¨£æ€§å„ªåŒ–")

# å€å¡Š 1: è©±é¡Œèˆ‡å¼·åº¦è¨­å®š
st.header("æ­¥é©Ÿ 1ï¼šè¨­å®šåƒæ•¸")

col1, col2 = st.columns(2)

with col1:
    category = st.selectbox(
        "è«‹é¸æ“‡è­°é¡Œé¡åˆ¥ï¼š",
        ["é†«ç¾é–’èŠ/å…«å¦ (ä¸é™å®¹è²Œç„¦æ…®)", "è¨ºæ‰€é»‘å¹•/éŠ·å”®è©±è¡“", "é›»éŸ³æ³¢/å„€å™¨å¿ƒå¾—", "é‡åŠ‘/å¾®æ•´ (ç»å°¿é…¸/è‚‰æ¯’)", "å‡é«”/æ‰‹è¡“ (éš†ä¹³/éš†é¼»)", "ä¿å¥é£Ÿå“/é¤Šç”Ÿ/æ¸›è‚¥"]
    )

with col2:
    # æ–°å¢ï¼šèªæ°£å¼·åº¦æ»‘æ¡¿
    tone_intensity = st.select_slider(
        "ğŸ”¥ é¸æ“‡æ¨™é¡Œ/æ–‡æ¡ˆå¼·åº¦ï¼š",
        options=["æº«å’Œç†æ€§", "ç†±çƒˆè¨è«–", "è¾›è¾£ç‚ä¸Š"],
        value="ç†±çƒˆè¨è«–"
    )

# æ ¹æ“šå¼·åº¦è¨­å®šæç¤ºè©
tone_prompt = ""
if tone_intensity == "æº«å’Œç†æ€§":
    tone_prompt = "èªæ°£è¦ç†æ€§ã€å®¢è§€ã€æº«æŸ”ã€‚é©åˆç´”å¿ƒå¾—åˆ†äº«ã€ç™¼å•æˆ–è¡›æ•™è¨è«–ï¼Œé¿å…éæ¿€è¨€è©ã€‚"
elif tone_intensity == "ç†±çƒˆè¨è«–":
    tone_prompt = "èªæ°£è¦æ´»æ½‘ã€å£èªåŒ–ï¼Œç¬¦åˆä¸€èˆ¬è«–å£‡çš„ç†±é–€è¨è«–é¢¨æ ¼ï¼Œå¸¶æœ‰æ­£å¸¸çš„æƒ…ç·’èµ·ä¼ã€‚"
elif tone_intensity == "è¾›è¾£ç‚ä¸Š":
    tone_prompt = "èªæ°£è¦éå¸¸å¼·çƒˆã€ä¸»è§€ã€å¸¶æœ‰çˆ­è­°æ€§ï¼ˆæˆ°é»ï¼‰ã€‚å¯ä»¥ä½¿ç”¨æ¿€å•ã€è«·åˆºã€éåº¦ç„¦æ…®æˆ–æ†¤æ€’çš„å£å»ï¼Œç›®æ¨™æ˜¯å¼•èµ·å…©æ´¾äººé¦¬æ¿€è¾¯ã€‚"

# æ¥­é…è¨­å®š
with st.expander("é€²éšè¨­å®šï¼šæ¥­é…ç½®å…¥ (é¸å¡«)"):
    is_promotion = st.checkbox("é–‹å•Ÿç½®å…¥æ¨¡å¼")
    product_info = st.text_input("è¼¸å…¥ç”¢å“åç¨±èˆ‡è³£é» (ä¾‹å¦‚ï¼šç‡Ÿé¤Šå¸«è¼•é£ŸNMNï¼Œå¤©ç„¶é…µæ¯ä¾†æº)")

# åˆå§‹åŒ– session state
if 'generated_titles' not in st.session_state:
    st.session_state.generated_titles = []

# æŒ‰éˆ•ï¼šç”Ÿæˆæ¨™é¡Œ
if st.button("ğŸš€ ç”Ÿæˆ 5 å€‹æ¨™é¡Œ"):
    with st.spinner(f'AI æ­£åœ¨ç™¼æƒ³ã€{tone_intensity}ã€‘é¢¨æ ¼çš„æ¨™é¡Œ...'):
        try:
            # é€™è£¡åŠ å…¥äº†æ›´åš´æ ¼çš„å¤šæ¨£æ€§æŒ‡ä»¤
            prompt = f"""
            {SYSTEM_INSTRUCTION}
            
            ä½¿ç”¨è€…é¸æ“‡çš„ä¸»é¡Œæ˜¯ï¼šã€Œ{category}ã€
            ä½¿ç”¨è€…å¸Œæœ›çš„èªæ°£å¼·åº¦æ˜¯ï¼šã€Œ{tone_intensity}ã€({tone_prompt})
            
            è«‹ç™¼æƒ³ 5 å€‹ PTT/Dcard é¢¨æ ¼çš„æ¨™é¡Œã€‚
            
            ã€åš´æ ¼è¦æ±‚ã€‘ï¼š
            1. **èªæ°£å¼·åº¦**ï¼šå¿…é ˆå®Œå…¨ç¬¦åˆã€Œ{tone_intensity}ã€çš„è¨­å®šã€‚
            2. **æ¥µè‡´å¤šæ¨£æ€§**ï¼šé€™ 5 å€‹æ¨™é¡Œå¿…é ˆåˆ‡å…¥ **5 å€‹å®Œå…¨ä¸åŒçš„é¢å‘**ã€‚
               - ä¾‹å¦‚ï¼šå¦‚æœæ˜¯ã€Œé†«ç¾é–’èŠã€ï¼Œä¸è¦å…¨éƒ¨éƒ½åœ¨è¬›å®¹è²Œç„¦æ…®ã€‚
               - è«‹åŒ…å«ï¼šé ç®—/CPå€¼è¨è«–ã€è¡“å¾Œç”Ÿæ´»ä¸ä¾¿ã€å°è¨ºæ‰€/é†«å¸«çš„è§€å¯Ÿã€å…©æ€§/äººéš›é—œä¿‚ã€æˆ–æ˜¯ç´”ç²¹çš„æŠ€è¡“ç–‘å•ã€‚
               - **çµ•å°ä¸è¦**è®“ 5 å€‹æ¨™é¡Œçœ‹èµ·ä¾†å¾ˆåƒã€‚
            
            è«‹ç›´æ¥åˆ—å‡º 5 å€‹æ¨™é¡Œï¼Œä¸è¦æœ‰ç·¨è™Ÿæˆ–å‰è¨€ã€‚
            """
            
            response = model.generate_content(prompt)
            titles = response.text.strip().split('\n')
            st.session_state.generated_titles = [t.strip() for t in titles if t.strip()]
            
        except Exception as e:
            st.error(f"ç”Ÿæˆå¤±æ•—ï¼š{e}")

# æ­¥é©Ÿ 2: é¸æ“‡ä¸¦ç”Ÿæˆå…§å®¹
if st.session_state.generated_titles:
    st.header("æ­¥é©Ÿ 2ï¼šé¸æ“‡æ¨™é¡Œä¸¦ç”Ÿæˆå…§å®¹")
    selected_title = st.radio("è«‹é¸æ“‡ä¸€å€‹æ¨™é¡Œï¼š", st.session_state.generated_titles)
    
    if st.button("âœ¨ ç”Ÿæˆå…§æ–‡èˆ‡å›æ–‡"):
        with st.spinner('AI æ­£åœ¨æ’°å¯«æ–‡ç« èˆ‡æ°´è»å›è¦†...'):
            try:
                content_prompt = f"""
                {SYSTEM_INSTRUCTION}
                
                æ¨™é¡Œï¼š{selected_title}
                èªæ°£å¼·åº¦ï¼š{tone_intensity} ({tone_prompt})
                
                è«‹å®Œæˆä»¥ä¸‹ä»»å‹™ï¼š
                1. æ’°å¯«ã€å…§æ–‡ã€‘ï¼šç´„ 100-150 å­—ï¼Œèªæ°£è¦ç¬¦åˆæ¨™é¡Œèˆ‡å¼·åº¦è¨­å®šã€‚
                2. æ’°å¯«ã€å›æ–‡ã€‘ï¼š10 å‰‡æ¨æ–‡/å™“æ–‡ (æ ¼å¼ç¯„ä¾‹ï¼šæ¨| é€™æ˜¯å›æ–‡å…§å®¹)ã€‚
                   - å›æ–‡çš„ç«‹å ´è¦å¤šå…ƒï¼ˆæœ‰çš„èªåŒã€æœ‰çš„åé§ã€æœ‰çš„æ­ªæ¨“ï¼‰ã€‚
                """
                
                if is_promotion and product_info:
                    content_prompt += f"""
